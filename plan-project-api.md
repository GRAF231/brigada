# План разработки API для работы с проектами

## Обзор задачи

Разработка API для работы с проектами, сметами, графиками работ и статусами. Эта задача является важным шагом в реализации сервиса для управления ремонтом квартир, так как позволит интегрировать фронтенд с бэкендом и реализовать полноценную функциональность.

## Текущее состояние

В настоящее время в приложении есть:
- Модели данных для проектов, смет, графиков работ и статусов
- Базовая структура серверной части с настроенным Express.js
- API для работы с пользователями
- Фронтенд с реализованной страницей детального просмотра проекта с вкладками

Однако отсутствуют:
- Контроллеры для проектов, смет, графиков работ и статусов
- Маршруты для проектов, смет, графиков работ и статусов
- API эндпоинты для работы с проектами и связанными с ними данными

## Архитектурное решение

Мы будем следовать RESTful API подходу для создания эндпоинтов. Для каждой сущности (проект, смета, график работ, статус) будет создан отдельный контроллер и маршрут. Это обеспечит модульность и масштабируемость API.

```mermaid
graph TD
    A[Клиент] --> B[API]
    B --> C[Контроллеры]
    C --> D[Модели]
    D --> E[База данных]
    
    subgraph "API Маршруты"
    B1[/api/projects]
    B2[/api/projects/:id/estimate]
    B3[/api/projects/:id/schedule]
    B4[/api/projects/:id/status]
    end
    
    subgraph "Контроллеры"
    C1[projectController]
    C2[estimateController]
    C3[scheduleController]
    C4[statusController]
    end
    
    B1 --> C1
    B2 --> C2
    B3 --> C3
    B4 --> C4
```

## Компоненты для реализации

1. **projectController.ts** - контроллер для работы с проектами
   - Создание проекта
   - Получение списка проектов
   - Получение проекта по ID
   - Обновление проекта
   - Удаление проекта
   - Получение участников проекта

2. **projectRoutes.ts** - маршруты для работы с проектами
   - Определение маршрутов для проектов
   - Подключение middleware для авторизации

3. **estimateController.ts** - контроллер для работы со сметами
   - Создание сметы для проекта
   - Получение сметы проекта
   - Добавление позиции в смету
   - Обновление позиции сметы
   - Удаление позиции сметы

4. **estimateRoutes.ts** - маршруты для работы со сметами
   - Определение маршрутов для смет
   - Подключение middleware для авторизации

5. **scheduleController.ts** - контроллер для работы с графиками работ
   - Создание графика работ для проекта
   - Получение графика работ проекта
   - Добавление работы в график
   - Обновление работы в графике
   - Удаление работы из графика

6. **scheduleRoutes.ts** - маршруты для работы с графиками работ
   - Определение маршрутов для графиков работ
   - Подключение middleware для авторизации

7. **statusController.ts** - контроллер для работы со статусами
   - Создание сообщения о статусе
   - Получение истории статусов проекта
   - Загрузка файлов для сообщения о статусе

8. **statusRoutes.ts** - маршруты для работы со статусами
   - Определение маршрутов для статусов
   - Подключение middleware для авторизации и загрузки файлов

## Технические детали

### API эндпоинты

#### Проекты

1. `GET /api/projects` - получение списка проектов
   - Параметры запроса:
     - `limit` - количество проектов на странице
     - `page` - номер страницы
     - `status` - фильтр по статусу
   - Ответ: массив проектов с основной информацией

2. `POST /api/projects` - создание нового проекта
   - Тело запроса: данные проекта (name, address, startDate, endDate, clientId, managerId)
   - Ответ: созданный проект

3. `GET /api/projects/:id` - получение проекта по ID
   - Ответ: детальная информация о проекте

4. `PUT /api/projects/:id` - обновление проекта
   - Тело запроса: обновленные данные проекта
   - Ответ: обновленный проект

5. `DELETE /api/projects/:id` - удаление проекта
   - Ответ: подтверждение удаления

6. `GET /api/projects/:id/users` - получение участников проекта
   - Ответ: массив пользователей, связанных с проектом

7. `POST /api/projects/:id/users` - добавление пользователя в проект
   - Тело запроса: userId и роль пользователя в проекте
   - Ответ: обновленный список участников проекта

#### Сметы

1. `GET /api/projects/:id/estimate` - получение сметы проекта
   - Ответ: смета проекта с позициями

2. `POST /api/projects/:id/estimate` - создание сметы для проекта
   - Ответ: созданная смета

3. `POST /api/estimates/:id/items` - добавление позиции в смету
   - Тело запроса: данные позиции (name, unit, quantity, price, parentId)
   - Ответ: созданная позиция сметы

4. `PUT /api/estimate-items/:id` - обновление позиции сметы
   - Тело запроса: обновленные данные позиции
   - Ответ: обновленная позиция сметы

5. `PATCH /api/estimate-items/:id/status` - обновление статуса позиции сметы
   - Тело запроса: новый статус
   - Ответ: обновленная позиция сметы

6. `DELETE /api/estimate-items/:id` - удаление позиции сметы
   - Ответ: подтверждение удаления

#### Графики работ

1. `GET /api/projects/:id/schedule` - получение графика работ проекта
   - Ответ: график работ проекта с работами

2. `POST /api/projects/:id/schedule` - создание графика работ для проекта
   - Ответ: созданный график работ

3. `POST /api/schedules/:id/items` - добавление работы в график
   - Тело запроса: данные работы (name, startDate, endDate)
   - Ответ: созданная работа

4. `PUT /api/schedule-items/:id` - обновление работы в графике
   - Тело запроса: обновленные данные работы
   - Ответ: обновленная работа

5. `PATCH /api/schedule-items/:id/status` - обновление статуса работы
   - Тело запроса: новый статус
   - Ответ: обновленная работа

6. `DELETE /api/schedule-items/:id` - удаление работы из графика
   - Ответ: подтверждение удаления

#### Статусы

1. `GET /api/projects/:id/status` - получение истории статусов проекта
   - Параметры запроса:
     - `limit` - количество сообщений на странице
     - `page` - номер страницы
   - Ответ: массив сообщений о статусе

2. `POST /api/projects/:id/status` - создание сообщения о статусе
   - Тело запроса: данные сообщения (message)
   - Ответ: созданное сообщение о статусе

3. `POST /api/status-messages/:id/attachments` - загрузка файлов для сообщения о статусе
   - Тело запроса: файлы (multipart/form-data)
   - Ответ: обновленное сообщение о статусе с прикрепленными файлами

## План реализации

### 1. Создание контроллера и маршрутов для проектов

1. Создать файл `server/src/controllers/projectController.ts`
2. Реализовать основные CRUD операции для проектов
3. Создать файл `server/src/routes/projectRoutes.ts`
4. Определить маршруты для проектов
5. Подключить маршруты в `server/src/index.ts`
6. Протестировать API эндпоинты для проектов

### 2. Создание контроллера и маршрутов для смет

1. Создать файл `server/src/controllers/estimateController.ts`
2. Реализовать операции для работы со сметами и позициями смет
3. Создать файл `server/src/routes/estimateRoutes.ts`
4. Определить маршруты для смет
5. Подключить маршруты в `server/src/index.ts`
6. Протестировать API эндпоинты для смет

### 3. Создание контроллера и маршрутов для графиков работ

1. Создать файл `server/src/controllers/scheduleController.ts`
2. Реализовать операции для работы с графиками работ
3. Создать файл `server/src/routes/scheduleRoutes.ts`
4. Определить маршруты для графиков работ
5. Подключить маршруты в `server/src/index.ts`
6. Протестировать API эндпоинты для графиков работ

### 4. Создание контроллера и маршрутов для статусов

1. Создать файл `server/src/controllers/statusController.ts`
2. Реализовать операции для работы со статусами
3. Создать файл `server/src/routes/statusRoutes.ts`
4. Определить маршруты для статусов
5. Настроить middleware для загрузки файлов
6. Подключить маршруты в `server/src/index.ts`
7. Протестировать API эндпоинты для статусов

### 5. Интеграция с фронтендом

1. Обновить файл `client/src/utils/api.ts` для работы с новыми API эндпоинтами
2. Обновить компоненты вкладок для использования API
3. Реализовать функциональность редактирования проекта
4. Реализовать функциональность добавления участников в проект

## Оценка времени

| Задача | Оценка времени |
|--------|----------------|
| Создание контроллера и маршрутов для проектов | 4 часа |
| Создание контроллера и маршрутов для смет | 6 часов |
| Создание контроллера и маршрутов для графиков работ | 4 часа |
| Создание контроллера и маршрутов для статусов | 6 часов |
| Интеграция с фронтендом | 8 часов |
| Тестирование и отладка | 4 часа |
| **Итого** | **32 часа** |

## Потенциальные проблемы и решения

1. **Проблема**: Сложность реализации иерархической структуры для позиций сметы.
   **Решение**: Использовать рекурсивные запросы для получения всех дочерних позиций или реализовать специальный метод в модели для работы с иерархией.

2. **Проблема**: Обработка загрузки файлов для сообщений о статусе.
   **Решение**: Использовать middleware Multer для обработки загрузки файлов и сохранения их на сервере.

3. **Проблема**: Обеспечение безопасности API и разграничение доступа для разных ролей пользователей.
   **Решение**: Реализовать middleware для проверки прав доступа на основе роли пользователя и его связи с проектом.

4. **Проблема**: Производительность при работе с большими объемами данных.
   **Решение**: Реализовать пагинацию для запросов, возвращающих списки данных, и оптимизировать запросы к базе данных.

## Заключение

Разработка API для работы с проектами является важным шагом в реализации сервиса для управления ремонтом квартир. Это позволит интегрировать фронтенд с бэкендом и реализовать полноценную функциональность. После завершения этой задачи мы сможем перейти к более детальной реализации вкладок на странице детального просмотра проекта.